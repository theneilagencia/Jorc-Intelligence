name: "ðŸ” Monitor Pipeline & Deploy"

on:
  schedule:
    # Executar a cada 30 minutos
    - cron: '*/30 * * * *'
  workflow_dispatch: # Permitir execuÃ§Ã£o manual
  push:
    branches:
      - main
    paths:
      - '.github/workflows/deploy.yaml'
      - '.github/workflows/monitor.yaml'

permissions:
  contents: write
  issues: write

jobs:
  monitor:
    name: "Monitor Render Deployment Status"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ðŸ§© Checkout repository"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: "ðŸ“Š Query Render API for service status"
        id: render_status
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: "srv-d3sk5h1r0fns738ibdg0"
        run: |
          echo "ðŸ” Consultando status do serviÃ§o no Render..."
          
          if [ -z "$RENDER_API_KEY" ]; then
            echo "âš ï¸ RENDER_API_KEY nÃ£o configurado - usando apenas deploy hook"
            echo "status=unknown" >> $GITHUB_OUTPUT
            echo "deploy_status=unknown" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Consultar status do serviÃ§o
          SERVICE_RESPONSE=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID" || echo '{"error": true}')
          
          SERVICE_STATUS=$(echo "$SERVICE_RESPONSE" | jq -r '.service.serviceDetails.status // "unknown"')
          echo "ðŸ“ Service Status: $SERVICE_STATUS"
          echo "status=$SERVICE_STATUS" >> $GITHUB_OUTPUT
          
          # Consultar Ãºltimo deploy
          DEPLOYS_RESPONSE=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys?limit=1" || echo '[]')
          
          DEPLOY_STATUS=$(echo "$DEPLOYS_RESPONSE" | jq -r '.[0].deploy.status // "unknown"')
          DEPLOY_ID=$(echo "$DEPLOYS_RESPONSE" | jq -r '.[0].deploy.id // "unknown"')
          DEPLOY_CREATED=$(echo "$DEPLOYS_RESPONSE" | jq -r '.[0].deploy.createdAt // "unknown"')
          DEPLOY_FINISHED=$(echo "$DEPLOYS_RESPONSE" | jq -r '.[0].deploy.finishedAt // "unknown"')
          
          echo "ðŸ“¦ Deploy Status: $DEPLOY_STATUS"
          echo "ðŸ†” Deploy ID: $DEPLOY_ID"
          echo "â° Created: $DEPLOY_CREATED"
          echo "âœ… Finished: $DEPLOY_FINISHED"
          
          echo "deploy_status=$DEPLOY_STATUS" >> $GITHUB_OUTPUT
          echo "deploy_id=$DEPLOY_ID" >> $GITHUB_OUTPUT
          echo "deploy_created=$DEPLOY_CREATED" >> $GITHUB_OUTPUT
          echo "deploy_finished=$DEPLOY_FINISHED" >> $GITHUB_OUTPUT
          
          # Salvar resposta completa para debug
          echo "$SERVICE_RESPONSE" > /tmp/service_status.json
          echo "$DEPLOYS_RESPONSE" > /tmp/deploy_status.json
      
      - name: "ðŸ“ Update PIPELINE.md with current status"
        run: |
          mkdir -p docs
          
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          SERVICE_STATUS="${{ steps.render_status.outputs.status }}"
          DEPLOY_STATUS="${{ steps.render_status.outputs.deploy_status }}"
          DEPLOY_ID="${{ steps.render_status.outputs.deploy_id }}"
          
          # Definir emoji baseado no status
          if [ "$SERVICE_STATUS" = "available" ] || [ "$SERVICE_STATUS" = "live" ]; then
            STATUS_EMOJI="âœ…"
          elif [ "$SERVICE_STATUS" = "unknown" ]; then
            STATUS_EMOJI="âš ï¸"
          else
            STATUS_EMOJI="âŒ"
          fi
          
          # Criar ou atualizar PIPELINE.md
          cat > docs/PIPELINE.md << EOF
          # ðŸ” Pipeline Status - ComplianceCore Mining
          
          **Ãšltima verificaÃ§Ã£o**: $TIMESTAMP
          
          ## ðŸ“Š Status Atual
          
          | Componente | Status | Detalhes |
          |------------|--------|----------|
          | Render Service | $STATUS_EMOJI $SERVICE_STATUS | Service ID: \`srv-d3sk5h1r0fns738ibdg0\` |
          | Ãšltimo Deploy | $DEPLOY_STATUS | Deploy ID: \`$DEPLOY_ID\` |
          | GitHub Actions | âœ… Ativo | [Ver Workflows](https://github.com/${{ github.repository }}/actions) |
          
          ## ðŸ”— Links Ãšteis
          
          - ðŸŒ **ProduÃ§Ã£o**: https://qivo-mining.onrender.com
          - ðŸ“Š **Render Dashboard**: https://dashboard.render.com/web/srv-d3sk5h1r0fns738ibdg0
          - ðŸ”§ **GitHub Actions**: https://github.com/${{ github.repository }}/actions
          - ðŸ“ **Deploy Logs**: https://dashboard.render.com/web/srv-d3sk5h1r0fns738ibdg0/logs
          
          ## ðŸ“ˆ HistÃ³rico de Deploys
          
          | Data/Hora | Status | Deploy ID | DuraÃ§Ã£o |
          |-----------|--------|-----------|---------|
          | $TIMESTAMP | $DEPLOY_STATUS | \`$DEPLOY_ID\` | - |
          
          ## ðŸ”„ Monitoramento
          
          Este arquivo Ã© atualizado automaticamente a cada 30 minutos pelo workflow \`.github/workflows/monitor.yaml\`.
          
          ### AÃ§Ãµes Automatizadas
          
          - âœ… VerificaÃ§Ã£o de status via API Render
          - ðŸ“ AtualizaÃ§Ã£o automÃ¡tica desta documentaÃ§Ã£o
          - ðŸš¨ CriaÃ§Ã£o de issues em caso de falha
          - ðŸ”§ Auto-correÃ§Ã£o de erros conhecidos
          
          ---
          
          **Monitorado por**: GitHub Actions  
          **Ãšltima atualizaÃ§Ã£o**: $TIMESTAMP
          EOF
          
          echo "âœ… PIPELINE.md atualizado"
          cat docs/PIPELINE.md
      
      - name: "ðŸš¨ Create Issue if Deploy Failed"
        if: steps.render_status.outputs.deploy_status == 'failed' || steps.render_status.outputs.status == 'suspended'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const timestamp = new Date().toISOString();
            const deployId = '${{ steps.render_status.outputs.deploy_id }}';
            const serviceStatus = '${{ steps.render_status.outputs.status }}';
            const deployStatus = '${{ steps.render_status.outputs.deploy_status }}';
            
            const issueBody = `## âŒ Deploy Falhou
            
            **Data/Hora**: ${timestamp}
            **Service Status**: ${serviceStatus}
            **Deploy Status**: ${deployStatus}
            **Deploy ID**: \`${deployId}\`
            
            ### ðŸ” Detalhes
            
            O monitoramento automÃ¡tico detectou uma falha no deploy.
            
            ### ðŸ”— Links para InvestigaÃ§Ã£o
            
            - [Ver Logs no Render](https://dashboard.render.com/web/srv-d3sk5h1r0fns738ibdg0/logs)
            - [Ver Workflows](https://github.com/${{ github.repository }}/actions)
            - [Deploy Hook Config](https://dashboard.render.com/web/srv-d3sk5h1r0fns738ibdg0/settings)
            
            ### âš™ï¸ AÃ§Ãµes Sugeridas
            
            1. Verificar logs no Render Dashboard
            2. Verificar se hÃ¡ erros de build
            3. Verificar configuraÃ§Ã£o de environment variables
            4. Testar webhook manualmente:
               \`\`\`bash
               curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}"
               \`\`\`
            
            ---
            
            ðŸ¤– *Issue criada automaticamente pelo workflow de monitoramento*`;
            
            // Buscar issues abertas similares
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'deploy-failure,automated'
            });
            
            // Criar issue apenas se nÃ£o houver uma aberta recente
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `âŒ Deploy Falhou â€” ${new Date().toLocaleString()}`,
                body: issueBody,
                labels: ['deploy-failure', 'automated', 'urgent']
              });
              console.log('âœ… Issue criada com sucesso');
            } else {
              console.log('âš ï¸ JÃ¡ existe uma issue aberta sobre deploy failure');
            }
      
      - name: "ðŸ’¾ Commit and Push PIPELINE.md"
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          git add docs/PIPELINE.md
          
          if git diff --staged --quiet; then
            echo "ðŸ“ Nenhuma alteraÃ§Ã£o detectada em PIPELINE.md"
            exit 0
          fi
          
          git commit -m "docs: atualiza status do pipeline [skip ci]"
          
          # Tentar push com retry e rebase automÃ¡tico
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if git push origin main; then
              echo "âœ… Push realizado com sucesso"
              exit 0
            else
              echo "âš ï¸ Push falhou, tentando rebase..."
              git pull --rebase origin main
              RETRY_COUNT=$((RETRY_COUNT + 1))
              
              if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
                echo "âŒ Falha apÃ³s $MAX_RETRIES tentativas"
                exit 1
              fi
              
              sleep 2
            fi
          done
      
      - name: "ðŸ“Š Summary Report"
        run: |
          echo "### ðŸ” Monitoramento ConcluÃ­do" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service Status**: ${{ steps.render_status.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy Status**: ${{ steps.render_status.outputs.deploy_status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy ID**: \`${{ steps.render_status.outputs.deploy_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ DocumentaÃ§Ã£o atualizada em \`docs/PIPELINE.md\`" >> $GITHUB_STEP_SUMMARY
